<template>
  <view class="container padbox--default">
    <view class="registration--title">{{t.title}}</view>
    <view class="registration--subtitle">{{t.subtitle}}</view>
    <formparent>
      <button class="btn--default__dark" disabled="{{wechatDisabled}}" @tap="getWeChat">
        <image class="icon--inline" src="../icons/wechat_white.svg" mode="aspectFit"></image>
        {{t.login_with_wechat}}
      </button>
      <block wx:if="{{authData}}">
        <view class="form--group">
          <view class="form--group__title">{{t.basic_info}}</view>
          <view class="form-item--default">
            <view class="form-item--label">{{t.name}}</view>
            <view class="form-item--input">{{authData.nickName}}</view>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">{{t.name}}</view>
            <view class="form-item--input">{{authData.province}}, {{authData.city}}</view>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">{{t.wechat}}</view>
            <input type="text" placeholder="请输入你的微信号" class="form-item--input" @blur="handleWx" maxlength="70" confirm-type="next" value="{{wxUsername || ''}}"/>
          </view>
          <view class="form-item--default">
            <view class="form-item--label">{{t.age}}</view>
            <input type="number" placeholder="输入你的年龄请" class="form-item--input" @blur="handleAge" maxlength="3" confirm-type="next" value="{{age || ''}}"/>
          </view>
        </view>
        <view class="form--group">
          <view class="form--group__title">{{t.self_intro}}</view>
          <view class="form-item--default">
            <view class="form-item--label">{{t.intro_explanation}}</view>
            <textarea class="form-item--textinput" @blur="handlePersonal" confirm-type="next" maxlength="200" value="{{personalNote}}"/>
          </view>
        </view>
        <view class="form--group">
          <view class="form--group__title">{{t.id_validation}}</view>
          <view class="form-item--label">{{t.id_subtitle}}</view>
          <view class="form-item--default">
            <radiolist @toggle.user="toggleIdType" :choices.sync="idChoices" :currentchoice.sync="idType"/>
          </view>
          <block wx:if="{{chooseChineseId}}">
            <view class="form-item--default">
              <view class="form-item--label">
                {{t.chinese_shenfenzheng}}
              </view>
              <input type="idcard" placeholder="身份证" class="form-item--input" @blur="handleId" confirm-type="next"/>
            </view>
          </block>
            <block wx:else>
              <view class="form-item--default">
                <view class="form-item--label__fullwidth">
                  <coolpicker @change.user="handleCountryChange" :collection.sync="countryChoices" :selection.sync="country" :label.sync="countryText"/>
                </view>
              </view>
              <view class="form-item--default">
                <view class="form-item--label">
                  {{t.full_name}}
                </view>
                <input type="text" placeholder="请输入你的全法律上的姓名" class="form-item--input" @blur="handleFullName" maxlength="50" confirm-type="next" value="{{fullName || ''}}"/>
              </view>
              <view class="form-item--default">
                <view class="form-item--label">
                  {{t.passport}}
                </view>
                <input type="number" placeholder="请输入护照号" class="form-item--input" @blur="handleId" maxlength="50" confirm-type="next" value="{{idNumber || ''}}"/>
              </view>
          </block>
        </view>
        <button class="btn--default" @tap="handleSubmit">{{t.save}}</button>
      </block>
    </formparent>
  </view>
  <redirectmodal/>
  <errormodal/>
  <fidoloader/>
</template>
<script>
  import wepy from 'wepy'
  import FormParent from '@/components/form-parent'
  import RedirectModal from '@/components/redirect-modal'
  import ErrorModal from '@/components/error-modal'
  import CoolPicker from '@/components/cool-picker'
  import RadioList from '@/components/radiolist'
  import FidoLoader from '@/components/fido-loader'
  import countryChoices from '@/utils/countries'
  import LocalesMixin from '@/mixins/localesmixin'
  import isEmpty from 'lodash.isempty'

  export default class RescuerRegistration extends wepy.page {
    data = {
      idChoices: [{
        name: '身份证',
        value: 'chinese_id'
      }, {
        name: '护照',
        value: 'passport'
      }],
      countryChoices: countryChoices,
      countryText: '护照国家 🎏',
      authData: null,
      wxUsername: null,
      personalNote: null,
      age: null,
      idNumber: '',
      idType: 'chinese_id',
      country: 'China',
      fullName: ''
    }

    mixins = [LocalesMixin]

    components = {
      formparent: FormParent,
      redirectmodal: RedirectModal,
      errormodal: ErrorModal,
      coolpicker: CoolPicker,
      radiolist: RadioList,
      fidoloader: FidoLoader
    }

    computed = {
      wechatDisabled () {
        return this.authData !== null
      },
      chooseChineseId () {
        return this.idType === 'chinese_id'
      },
      hasEmptyFields () {
        const {age, wxUsername, personalNote, idNumber, country, fullName} = this.data
        const fields = {age, wxUsername, personalNote, idNumber}
        if (this.idType === 'passport') {
          fields.country = country
          fields.fullName = fullName
        }
        const emptyFields = Object.keys(fields).filter(field => {
          let value = fields[field]
          if (value === '' || value === ' ' || value === null) {
            return field
          }
        })
        return isEmpty(emptyFields) ? false : emptyFields
      }
    }

    methods = {
      handleWx ({detail}) {
        this.wxUsername = detail.value
        this.$apply()
      },
      handlePersonal ({detail}) {
        this.personalNote = detail.value
        this.$apply()
      },
      handleAge ({detail}) {
        this.age = detail.value
        this.$apply()
      },
      handleId ({detail}) {
        this.idNumber = detail.value
        this.$apply()
      },
      handleFullName ({detail}) {
        this.fullName = detail.value
        this.$apply()
      },
      toggleIdType (e) {
        if (this.idType === 'chinese_id') {
          this.idType = 'passport'
        } else {
          this.idType = 'chinese_id'
        }
        this.idNumber = ''
        this.$apply()
      },
      handleCountryChange ({detail}) {
        this.country = countryChoices[detail.value]
        this.$apply()
      },
      reloadPage () {
        this.onLoad()
      }
    }

    onLoad () {
      this.isRegistered = this.$parent.globalData.user.isRegistered
      this.authData = this.$parent.globalData.user.attributes
      if (this.authData) this.diffAuthData()
      if (this.$parent.globalData.user.isRescuer) {
        const params = {
          message: '你已经是rescuer了，你可以在个人中心编辑你的资料',
          link: 'edit-profile',
          linkname: '编辑'
        }
        this.$invoke('redirectmodal', 'toggleModal', params)
      }
    }

    async getWeChat () {
      this.$invoke('fidoloader', 'showLoading', '')
      const user = this.$parent.globalData.user
      try {
        await user.authorize()
        this.authData = this.$parent.globalData.user.attributes
        this.$apply()
        this.diffAuthData()
        this.$invoke('fidoloader', 'hideLoading', '')
      } catch (err) {
        this.$invoke('fidoloader', 'hideLoading', '')
        // actually deal with the error maybe lol
        console.error(err)
        this.handleFetchError()
      }
    }

    handleFetchError () {
      const params = {
        header: '哎哟出错了😯',
        message: '刷新页面再试试一遍',
        refresh: true
      }
      this.$invoke('errormodal', 'showMessage', params)
    }

    async handleSubmit () {
      if (this.hasEmptyFields) return this.handleSubmitError()
      this.$invoke('fidoloader', 'showLoading', '')
      try {
        const {wxUsername, personalNote, age, idType, idNumber, fullName, country} = this.data
        await this.$parent.globalData.user.updateProfileInfo({wxUsername, personalNote, age, idType, idNumber, fullName, country})
        const params = {message: '恭喜你, 你已经成为fido的rescuer'}
        this.$invoke('fidoloader', 'hideLoading', '')
        this.$invoke('redirectmodal', 'toggleModal', params)
        this.$parent.globalData.user.fetchUpdate()
      } catch (err) {
        console.error(err)
        this.handleFetchError()
      }
    }

    handleSubmitError () {
      const params = {
        header: '认证失败 🙇‍',
        message: `你还没有填完你的信息，我们为了你的安全努力，请填完再提交谢谢🙏`
      }
      return this.$invoke('errormodal', 'showMessage', params)
    }

    diffAuthData () {
      this.age = this.authData.age || ''
      this.personalNote = this.authData.personalNote || ''
      this.wxUsername = this.authData.wxUsername || ''
      this.fullName = this.authData.fullName || ''
      this.idNumber = this.authData.idNumber || ''
      this.country = this.authData.country || 'china'
      this.idType = this.authData.idType || 'chinese_id'
      this.$apply()
    }
  }
</script>
